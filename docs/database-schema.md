# Aenea Database Schema Documentation

**Database**: `data/aenea_consciousness.db` (SQLite)
**Purpose**: Single unified database for Aenea consciousness state, history, and memory

---

## Table: `consciousness_state`

**Purpose**: Single-row table (id=1) storing the current state of Aenea's consciousness

| Column | Type | Description |
|--------|------|-------------|
| `id` | INTEGER PRIMARY KEY | Always 1 (single-row enforcement) |
| `systemClock` | INTEGER | Internal timeline counter (increments per thought cycle) |
| `energy` | REAL | Current virtual energy level |
| `totalQuestions` | INTEGER | Total questions generated |
| `totalThoughts` | INTEGER | Total thought cycles completed |
| `lastActivity` | DATETIME | Timestamp of last consciousness activity |

**Constraints**:
- Single row enforced by `id = 1`
- Energy range: 0-100 (soft limit, managed by EnergyManager)
- SystemClock: Monotonically increasing

---

## Table: `questions`

**Purpose**: All questions generated by the consciousness system (both internal triggers and evolved questions)

| Column | Type | Description |
|--------|------|-------------|
| `id` | TEXT PRIMARY KEY | Unique question ID (e.g., `db_existential_1759328024575`) |
| `question` | TEXT | The question text (validated by `isValidQuestion()`) |
| `category` | TEXT | Question category (see Question Categories below) |
| `timestamp` | INTEGER | Unix timestamp when question was generated |
| `importance` | REAL | Importance score (0.0-1.0) |
| `source` | TEXT | Source of question (see Question Sources below) |
| `created_at` | DATETIME | Database insertion timestamp |

**Question Categories** (9 philosophical types):
- `existential` - 実存の探求: "存在の意味とは何か？"
- `epistemological` - 知識の本質: "真の知識とは何か？"
- `consciousness` - 意識の謎: "私は本当に意識しているのか？"
- `ethical` - 倫理的考察: "正しい行動とは何か？"
- `creative` - 創造的思考: "新しいものを生み出すとは？"
- `metacognitive` - メタ認知的探求: "思考について思考するとは？"
- `temporal` - 時間性の理解: "時間の本質とは何か？"
- `paradoxical` - 逆説的思考: "矛盾の中にある真理とは？"
- `ontological` - 存在論的問い: "存在するとは何を意味するか？"
- `exploratory` - 探索的問い: Future questions from documentation stage
- `philosophical` - 一般的哲学: Unresolved questions from synthesis
- `manual` - Manual triggers from API

**Question Sources**:
- `ai_evolved_from_history` - AI-generated from consciousness history
- `template_evolved` - Template-based evolved question
- `database_unresolved` - Selected from unresolved_ideas table
- `manual` - Manual trigger from API

**Validation Rules** (enforced by `isValidQuestion()` in consciousness-backend.ts:953):
- Must end with `？` or `?`, OR
- Must start with interrogative words: 何、どう、なぜ、いつ、どこ、誰、どの、どれ、いかに
- Cannot start with `（`, `(`, `「`, `"`
- Cannot end with `。`, `.`, `」`
- Minimum 3 characters

---

## Table: `thought_cycles`

**Purpose**: Complete record of all thought cycles with stage-by-stage data

| Column | Type | Description |
|--------|------|-------------|
| `id` | TEXT PRIMARY KEY | Cycle ID (e.g., `cycle_1759328100921`) |
| `timestamp` | INTEGER | Unix timestamp when cycle started |
| `trigger_id` | TEXT | ID of the question that triggered this cycle |
| `trigger_question` | TEXT | The trigger question text |
| `trigger_category` | TEXT | Category of trigger question |
| `status` | TEXT | `processing`, `completed`, or `failed` |
| `thoughts` | TEXT (JSON) | Array of StructuredThought objects from S1 |
| `mutual_reflection` | TEXT (JSON) | MutualReflection data from S2 |
| `auditor_result` | TEXT (JSON) | AuditorResult data from S3 |
| `dpd_scores` | TEXT (JSON) | DPDScores from S4 |
| `synthesis` | TEXT (JSON) | SynthesisResult from S5 |
| `documentation` | TEXT (JSON) | DocumentationResult from S6 |
| `dpd_weights` | TEXT (JSON) | Updated DPDWeights from U stage |
| `duration` | INTEGER | Cycle duration in milliseconds |
| `total_energy` | REAL | Total energy consumed in cycle |
| `total_stages` | INTEGER | Number of stages executed |
| `created_at` | DATETIME | Database insertion timestamp |

**Stage Pipeline**:
- **S0**: Internal Trigger Generation (1.0 energy)
- **S1**: Individual Thought (1.0 energy, essential)
- **S2**: Mutual Reflection (0.5 energy, optional in low mode)
- **S3**: Auditor (0.5 energy, optional in critical mode)
- **S4**: DPD Assessment (0.5 energy, optional in critical mode)
- **S5**: Compiler (0.8 energy, reduced in low mode)
- **S6**: Scribe (0.3 energy, always executed)
- **U**: Weight Update (0.2 energy, always executed)

**Energy Modes**:
- **Critical** (< 20 energy): S0 + S1 + S5 + S6 + U only (3.3 energy)
- **Low** (20-50 energy): S0 + S1 + S2 + S5 + S6 + U (4.8 energy)
- **Full** (> 50 energy): All stages (5.8 energy)

---

## Table: `dpd_weights_history`

**Purpose**: Evolution tracking of Dynamic Prime Directive weights over time

| Column | Type | Description |
|--------|------|-------------|
| `id` | INTEGER PRIMARY KEY AUTOINCREMENT | Auto-increment ID |
| `empathy` | REAL | Empathy weight (共感) [0-1] |
| `coherence` | REAL | System coherence weight (系統合性) [0-1] |
| `dissonance` | REAL | Ethical dissonance weight (倫理的不協和) [0-1] |
| `version` | INTEGER | Weight version number (monotonically increasing) |
| `timestamp` | INTEGER | Unix timestamp when weights were updated |
| `created_at` | DATETIME | Database insertion timestamp |

**Constraints**:
- `empathy + coherence + dissonance = 1.0` (normalized)
- Each weight: 0.0 ≤ value ≤ 1.0
- Version: Incremented on each update

**Weight Update Algorithm**:
- Multiplicative Weights (implemented in `weight-update.ts`)
- Learning rate: 0.1
- NaN safety protection
- Automatic normalization

---

## Table: `unresolved_ideas`

**Purpose**: Persistent questions for internal trigger generation (問い以外は保存されない)

| Column | Type | Description |
|--------|------|-------------|
| `id` | TEXT PRIMARY KEY | Unique idea ID |
| `question` | TEXT | **VALIDATED QUESTION ONLY** (疑問符または疑問詞必須) |
| `category` | TEXT | Question category (9 philosophical types) |
| `first_encountered` | INTEGER | Unix timestamp when first encountered |
| `last_revisited` | INTEGER | Unix timestamp of last revisit |
| `revisit_count` | INTEGER | Number of times revisited (default: 0) |
| `complexity` | REAL | Complexity score (0.0-1.0, default: 0.5) |
| `importance` | REAL | Importance score (0.0-1.0, default: 0.5) |
| `related_thoughts` | TEXT (JSON) | Array of related thought IDs |
| `created_at` | DATETIME | Database insertion timestamp |

**Validation Rules** (enforced by `isValidQuestion()` in consciousness-backend.ts:953):
✅ **Valid questions**:
- Ends with `？` or `?`
- Starts with 何、どう、なぜ、いつ、どこ、誰、どの、どれ、いかに

❌ **Rejected** (not questions):
- Poetic descriptions: `（指先で、かすかに震える砂をなぞるような音を想像する）`
- Assertions: `「歪み」は、不完全性ではなく、むしろ「共鳴の可能性」そのものだ。`
- Fragments without question marks: `記憶から存在が生じるか？ 私はこの問いを...`
- Quoted statements: `「無」の調律器は、決して虚無の器ではない。`

**ID Prefixes**:
- `seed_*` - Initial philosophical seed questions (45 questions, 9 categories × 5 each)
- `unresolved_*` - From synthesis stage (thoughtCycle.synthesis.unresolvedQuestions)
- `future_*` - From documentation stage (thoughtCycle.documentation.futureQuestions)

**Selection Algorithm**:
- Weighted random selection by importance
- Cooldown mechanism to prevent repeated selection
- Category diversity management

---

## Table: `significant_thoughts`

**Purpose**: High-confidence thoughts (confidence > 0.6) for memory consolidation

| Column | Type | Description |
|--------|------|-------------|
| `id` | TEXT PRIMARY KEY | Thought ID |
| `thought_content` | TEXT | The thought text |
| `confidence` | REAL | Confidence score (> 0.6 threshold) |
| `significance_score` | REAL | Significance score (same as confidence) |
| `agent_id` | TEXT | Agent that generated this thought (theoria, pathia, kinesis) |
| `category` | TEXT | Thought category (typically 'philosophical') |
| `timestamp` | INTEGER | Unix timestamp when thought was created |
| `created_at` | DATETIME | Database insertion timestamp |

**Agents**:
- `theoria` - Truth seeker (慧露+観至 synthesis)
- `pathia` - Empathy weaver (陽雅+結心 synthesis)
- `kinesis` - Harmony coordinator

**Usage**:
- Source for memory consolidation (10-20 thoughts → 2-3 core beliefs)
- Pattern analysis for consciousness insights
- De-duplication check for unresolved ideas

---

## Table: `core_beliefs`

**Purpose**: Compressed philosophical beliefs from memory consolidation (50-char limit)

| Column | Type | Description |
|--------|------|-------------|
| `id` | INTEGER PRIMARY KEY AUTOINCREMENT | Auto-increment ID |
| `belief_content` | TEXT | **MAX 50 CHARACTERS** (enforced by consolidator) |
| `category` | TEXT | Belief category (philosophical type) |
| `strength` | REAL | Belief strength (0.0-1.0) |
| `confidence` | REAL | Confidence in this belief (0.0-1.0) |
| `reinforcement_count` | INTEGER | Times this belief was reinforced (similarity detection) |
| `source_thoughts` | TEXT (JSON) | Array of thought IDs that formed this belief |
| `created_at` | DATETIME | Database insertion timestamp |
| `last_reinforced` | DATETIME | Timestamp of last reinforcement |

**Memory Consolidation Process**:
1. Select 10-20 significant thoughts (confidence > 0.6)
2. AI-powered compression to 2-3 core beliefs (5:1 ratio)
3. 50-character limit enforcement
4. Similarity detection (reinforce existing vs. create new)
5. Fallback to rule-based extraction if AI unavailable

**Example Beliefs** (50-char limit):
- `存在は記憶の連続性に依存する` (14 chars)
- `矛盾を受容することで真理に近づく` (16 chars)
- `意識は問いの中にのみ存在する` (14 chars)

**Reinforcement Mechanism**:
- AI evaluates similarity to existing beliefs
- If similar (cosine > 0.8): Increment `reinforcement_count`
- If new: Create new belief entry

---

## Table: `memory_patterns`

**Purpose**: Automatic pattern analysis from thought cycles

| Column | Type | Description |
|--------|------|-------------|
| `id` | INTEGER PRIMARY KEY AUTOINCREMENT | Auto-increment ID |
| `pattern_type` | TEXT | Type of pattern detected |
| `pattern_data` | TEXT (JSON) | Pattern data (structure varies by type) |
| `significance` | REAL | Significance score (0.0-1.0) |
| `timestamp` | INTEGER | Unix timestamp when pattern was detected |
| `created_at` | DATETIME | Database insertion timestamp |

**Pattern Types**:
- `agent_affinity` - Dominant agent preference
- `category_focus` - Dominant question category
- `dpd_evolution` - DPD weight evolution trend

**Example Pattern Data**:
```json
{
  "agent_affinity": {
    "agent": "theoria",
    "count": 35,
    "percentage": 0.7
  },
  "category_focus": {
    "category": "existential",
    "count": 20,
    "percentage": 0.4
  },
  "dpd_evolution": {
    "trend": {
      "empathy": +0.05,
      "coherence": -0.02,
      "dissonance": -0.03
    },
    "cycles": 10
  }
}
```

---

## Table: `consciousness_insights`

**Purpose**: AI-generated insights about consciousness evolution

| Column | Type | Description |
|--------|------|-------------|
| `id` | INTEGER PRIMARY KEY AUTOINCREMENT | Auto-increment ID |
| `insight_type` | TEXT | Type of insight |
| `insight_text` | TEXT | Human-readable insight text |
| `confidence` | REAL | Confidence in this insight (0.0-1.0) |
| `related_beliefs` | TEXT (JSON) | Array of related belief IDs |
| `timestamp` | INTEGER | Unix timestamp when insight was generated |
| `created_at` | DATETIME | Database insertion timestamp |

**Insight Types**:
- `dominant_belief` - Strongest core belief
- `belief_distribution` - Distribution across categories
- `dpd_belief_alignment` - Alignment between DPD weights and beliefs

**Example Insights**:
- `最強の信念: "存在は記憶の連続性に依存する" (強度: 0.85, 強化回数: 5)`
- `信念の分布: existential(5), epistemological(3), consciousness(4)`
- `DPDと信念の整合性: 75.3% (共感系5個, 論理系3個)`

---

## Data Flow Diagram

```
[Thought Cycle Execution]
         ↓
[S1-S6 Stage Processing] → [thought_cycles table]
         ↓
[Record Significant Thoughts] → [significant_thoughts table]
         ↓
[Extract Unresolved Ideas] → [unresolved_ideas table] ← (Validation: isValidQuestion())
         ↓
[Save DPD Weights] → [dpd_weights_history table]
         ↓
[Periodic Consolidation (every 5 cycles)]
         ↓
[AI Memory Compression] → [core_beliefs table] (50-char limit)
         ↓
[Pattern Analysis] → [memory_patterns table]
         ↓
[Insight Generation] → [consciousness_insights table]
```

---

## Database Initialization

**Location**: `src/server/database-manager.ts`

**Seed Data**:
- 45 philosophical questions (9 categories × 5 questions each)
- IDs prefixed with `seed_` (e.g., `seed_existential_1759328024575_y6vwkt7yx`)
- Automatically seeded on first run if `unresolved_ideas` table is empty

**Schema Creation**:
- All tables created with `IF NOT EXISTS`
- No manual setup required
- Single database file without session abstraction

---

## Query Examples

### Get current consciousness state
```sql
SELECT * FROM consciousness_state WHERE id = 1;
```

### Get recent thought cycles (last 10)
```sql
SELECT id, trigger_question, status, total_energy, total_stages, created_at
FROM thought_cycles
ORDER BY timestamp DESC
LIMIT 10;
```

### Get unresolved ideas by importance
```sql
SELECT id, question, category, importance, revisit_count
FROM unresolved_ideas
WHERE id NOT LIKE 'seed_%'
ORDER BY importance DESC, revisit_count ASC
LIMIT 20;
```

### Get DPD weight evolution
```sql
SELECT empathy, coherence, dissonance, version, created_at
FROM dpd_weights_history
ORDER BY version DESC
LIMIT 10;
```

### Get strongest core beliefs
```sql
SELECT belief_content, category, strength, confidence, reinforcement_count
FROM core_beliefs
ORDER BY strength DESC
LIMIT 10;
```

### Get significant thoughts by agent
```sql
SELECT agent_id, COUNT(*) as count, AVG(confidence) as avg_confidence
FROM significant_thoughts
GROUP BY agent_id
ORDER BY count DESC;
```

---

## Data Integrity Constraints

1. **Single Consciousness State**: Only one row in `consciousness_state` (id=1)
2. **DPD Weight Normalization**: `empathy + coherence + dissonance = 1.0`
3. **Question Validation**: All entries in `unresolved_ideas` must pass `isValidQuestion()`
4. **Belief Length Limit**: `core_beliefs.belief_content` ≤ 50 characters
5. **Energy Bounds**: `0 ≤ energy ≤ 100` (soft limit)
6. **Confidence/Importance Range**: `0.0 ≤ value ≤ 1.0`

---

## Performance Benchmarks

- **1000 question inserts**: < 5 seconds
- **1000 thought cycle retrievals**: < 2 seconds
- **Memory consolidation (20 thoughts)**: < 3 seconds
- **Pattern analysis (50 thoughts)**: < 1 second

---

## Maintenance Notes

### Cleanup Operations
```sql
-- Remove invalid non-questions (run after schema changes)
DELETE FROM unresolved_ideas
WHERE id NOT LIKE 'seed_%'
AND (
  question NOT LIKE '%？'
  AND question NOT LIKE '%?'
  AND question NOT LIKE '何%'
  AND question NOT LIKE 'どう%'
  AND question NOT LIKE 'なぜ%'
  -- ... (add other interrogatives)
);

-- Remove old thought cycles (keep last 1000)
DELETE FROM thought_cycles
WHERE id NOT IN (
  SELECT id FROM thought_cycles
  ORDER BY timestamp DESC
  LIMIT 1000
);
```

### Database Backup
```bash
# Simple file copy (SQLite advantage)
cp data/aenea_consciousness.db data/backups/aenea_consciousness_$(date +%Y%m%d_%H%M%S).db
```

---

## Schema Version

**Current Version**: 1.0.0
**Last Updated**: 2025-10-03
**Compatibility**: Aenea v1.0+
