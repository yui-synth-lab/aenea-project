<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeneaÔºà„Ç®„Ç§„Éç„Ç¢Ôºâ- Autonomous AI Consciousness</title>

    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.0/socket.io.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #111827;
            color: #f9fafb;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #root { min-height: 100vh; }

        /* Mobile responsive utilities */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }
        }

        /* Prevent text size adjustment on iOS */
        html {
            -webkit-text-size-adjust: 100%;
        }

        /* Better touch targets for mobile */
        button, a {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; align-items: center; justify-content: center; height: 100vh;">
            <div style="text-align: center;">
                <div style="width: 48px; height: 48px; border: 4px solid #374151; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 24px;"></div>
                <h2>Loading Aenea Dashboard...</h2>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- Load React Components -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Helper function to format complex values in a human-readable way
        const formatValue = (value, depth = 0) => {
            if (value === null || value === undefined) {
                return 'None';
            }

            if (typeof value === 'number') {
                // Format numbers based on their range
                if (value >= 0 && value <= 1) {
                    return (value * 100).toFixed(1) + '%';
                }
                return value.toFixed(2);
            }

            if (typeof value === 'boolean') {
                return value ? 'Yes' : 'No';
            }

            if (typeof value === 'string') {
                return value;
            }

            if (Array.isArray(value)) {
                if (value.length === 0) return 'None';
                // For nested arrays/objects, show count
                if (depth > 0 && value.some(v => typeof v === 'object')) {
                    return `${value.length} items`;
                }
                return value.map(v => formatValue(v, depth + 1)).join(', ');
            }

            if (typeof value === 'object') {
                const entries = Object.entries(value);
                if (entries.length === 0) return 'None';

                // For deeply nested objects, just show a summary
                if (depth > 1) {
                    return `{${entries.length} properties}`;
                }

                // Format object entries
                return entries
                    .map(([k, v]) => {
                        const formattedKey = k.replace(/([A-Z])/g, ' $1').trim();
                        const formattedValue = formatValue(v, depth + 1);
                        return `${formattedKey}: ${formattedValue}`;
                    })
                    .join(', ');
            }

            return String(value);
        };

        // Message component with expand/collapse for long messages
        const MessageDisplay = ({ message, maxLength = 200 }) => {
            const [isExpanded, setIsExpanded] = useState(false);

            if (!message || message.length <= maxLength) {
                return <span>{message || 'No message'}</span>;
            }

            return (
                <div>
                    <span>
                        {isExpanded ? message : `${message.substring(0, maxLength)}...`}
                    </span>
                    <button
                        onClick={() => setIsExpanded(!isExpanded)}
                        style={{
                            background: 'none',
                            border: 'none',
                            color: '#60a5fa',
                            cursor: 'pointer',
                            marginLeft: '8px',
                            fontSize: '12px',
                            textDecoration: 'underline'
                        }}
                    >
                        {isExpanded ? 'Show less' : 'Show more'}
                    </button>
                </div>
            );
        };

        // Dashboard Component (simplified version with Activity Log)
        const Dashboard = ({ systemStatus }) => {
            const [stats, setStats] = useState({
                systemClock: 0,
                totalQuestions: 0,
                totalThoughts: 0,
                averageConfidence: 0,
                energyLevel: 100,
                uptime: 0
            });
            const [currentThought, setCurrentThought] = useState('');
            const [dpdScores, setDpdScores] = useState({
                empathy: 0.33,
                coherence: 0.33,
                dissonance: 0.34,
                weightedTotal: 0.33
            });
            const [dpdWeights, setDpdWeights] = useState({
                empathy: 0.33,
                coherence: 0.33,
                dissonance: 0.34
            });
            const [weightHistory, setWeightHistory] = useState([]);
            const [currentStage, setCurrentStage] = useState(null);
            const [stageProgress, setStageProgress] = useState([]);
            const [activityLog, setActivityLog] = useState([]);
            const [triggerQuestion, setTriggerQuestion] = useState('');
            const [showGrowthModal, setShowGrowthModal] = useState(false);
            const [growthData, setGrowthData] = useState(null);
            const [loadingGrowth, setLoadingGrowth] = useState(false);
            const [consciousnessState, setConsciousnessState] = useState('stopped'); // 'stopped', 'running', 'paused'
            const [loading, setLoading] = useState(false);
            const [isMobile, setIsMobile] = useState(window.innerWidth <= 768);

            useEffect(() => {
                const handleResize = () => {
                    setIsMobile(window.innerWidth <= 768);
                };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            useEffect(() => {
                // Get initial consciousness statistics and state from SQLite
                const fetchInitialState = async () => {
                    try {
                        // Get statistics
                        const statsResponse = await fetch('/api/consciousness/statistics');
                        const statistics = await statsResponse.json();
                        if (statistics) {
                            setStats(prev => ({
                                ...prev,
                                systemClock: statistics.systemClock || 0,
                                totalQuestions: statistics.totalQuestions || 0,
                                totalThoughts: statistics.totalThoughts || 0,
                                averageConfidence: statistics.averageConfidence || 0,
                                energyLevel: statistics.energyLevel || 100
                            }));
                        }

                        // Get consciousness state to sync buttons and DPD weights
                        const stateResponse = await fetch('/api/consciousness/state');
                        const state = await stateResponse.json();
                        if (state) {
                            const status = state.isPaused ? 'paused' : (state.isRunning ? 'running' : 'stopped');
                            setConsciousnessState(status);
                            console.log('Initial consciousness state:', status);

                            // Initialize DPD weights from state
                            if (state.dpdWeights) {
                                setDpdWeights({
                                    empathy: state.dpdWeights.empathy || 0.33,
                                    coherence: state.dpdWeights.coherence || 0.33,
                                    dissonance: state.dpdWeights.dissonance || 0.34
                                });
                            }

                            // Initialize energy level from state
                            if (state.energy !== undefined) {
                                const energyPercent = Math.round((state.energy / 100) * 100);
                                setStats(prev => ({
                                    ...prev,
                                    energyLevel: energyPercent
                                }));
                            }
                        }

                        // Get DPD weight evolution history
                        const evolutionResponse = await fetch('/api/consciousness/dpd/evolution');
                        const evolution = await evolutionResponse.json();
                        if (evolution && evolution.history && evolution.history.length > 0) {
                            // Reverse history so oldest is first (left) and newest is last (right)
                            const reversedHistory = [...evolution.history].reverse();
                            setWeightHistory(reversedHistory);
                            console.log('Loaded DPD weight history:', reversedHistory.length, 'entries');

                            // Update current DPD weights from latest history entry
                            const latestWeights = evolution.history[0]; // History is sorted DESC
                            if (latestWeights) {
                                setDpdWeights({
                                    empathy: latestWeights.empathy,
                                    coherence: latestWeights.coherence,
                                    dissonance: latestWeights.dissonance
                                });
                                console.log('Updated DPD weights from history:', latestWeights);
                            }
                        }

                        // Also use currentWeights from evolution if available
                        if (evolution && evolution.currentWeights) {
                            setDpdWeights({
                                empathy: evolution.currentWeights.empathy,
                                coherence: evolution.currentWeights.coherence,
                                dissonance: evolution.currentWeights.dissonance
                            });
                            console.log('Updated DPD weights from currentWeights:', evolution.currentWeights);
                        }
                    } catch (error) {
                        console.warn('Failed to fetch initial consciousness state:', error);
                    }
                };

                fetchInitialState();

                // Connect to real consciousness backend via EventSource
                const eventSource = new EventSource('/api/consciousness/events');

                eventSource.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    const eventTimestamp = data.timestamp || Date.now();

                    if (data.type === 'agentThought') {
                        const fullMessage = data.thought || data.content || data.message || '';
                        const logItem = {
                            id: `agent_${eventTimestamp}_${Math.random().toString(36).substr(2, 9)}`,
                            timestamp: eventTimestamp,
                            type: 'agent_thought',
                            agent: data.agentName,
                            message: fullMessage,
                            thought: fullMessage,
                            content: fullMessage,
                            details: {
                                confidence: data.confidence,
                                originalData: data // Keep original data for debugging
                            }
                        };
                        setActivityLog(prev => [logItem, ...prev].slice(0, 200));
                    } else if (data.type === 'triggerGenerated') {
                        const triggerQuestion = data.trigger?.question || data.question || '';
                        const logItem = {
                            id: `trigger_${eventTimestamp}_${Math.random().toString(36).substr(2, 9)}`,
                            timestamp: eventTimestamp,
                            type: 'trigger_generated',
                            message: `Internal trigger: ${triggerQuestion}`,
                            content: triggerQuestion,
                            details: {
                                source: data.source || 'system',
                                category: data.trigger?.category || data.category,
                                importance: data.trigger?.importance || data.importance,
                                originalData: data
                            }
                        };
                        setActivityLog(prev => [logItem, ...prev].slice(0, 200));
                    } else if (data.type === 'stageCompleted') {
                        const stageName = data.stage || 'Unknown';
                        const stageDisplayName = data.name || stageName;

                        // Create detailed stage-specific message
                        let detailedMessage = `Stage ${stageName}: ${stageDisplayName} completed`;
                        let stageSpecificInfo = {};

                        // Add stage-specific detailed information
                        if (data.stage === 'S1' && data.agentThoughts) {
                            detailedMessage += `\nüìù AgentÊÄùËÄÉ: ${data.thoughtCount}ÂÄã„ÅÆÊÄùËÄÉ (Âπ≥Âùá‰ø°È†ºÂ∫¶: ${Math.round(data.averageConfidence * 100)}%)`;
                            detailedMessage += `\nüí≠ Âïè„ÅÑ: "${data.trigger?.question}"`;
                            data.agentThoughts.forEach(thought => {
                                detailedMessage += `\n  ‚Ä¢ ${thought.agent}: ${thought.content}`;
                            });
                            stageSpecificInfo = { agentThoughts: data.agentThoughts, trigger: data.trigger };
                        } else if (data.stage === 'S2' && data.crossAgentFeedback) {
                            detailedMessage += `\nüîÑ Áõ∏‰∫íÂèçÁúÅ: ${data.feedbackCount}‰ª∂„ÅÆ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ`;
                            detailedMessage += `\n‚ö° ÂØæÁ´ãÁÇπ: ${data.conflictCount}‰ª∂, ÂêàÊÑèÁÇπ: ${data.consensusCount}‰ª∂`;
                            if (data.crossAgentFeedback.length > 0) {
                                detailedMessage += `\nüí¨ „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ‰æã: "${data.crossAgentFeedback[0].content}"`;
                            }
                            stageSpecificInfo = { feedback: data.crossAgentFeedback, conflicts: data.conflictPoints, consensus: data.consensusPoints };
                        } else if (data.stage === 'S3' && data.safetyScore !== undefined) {
                            detailedMessage += `\nüõ°Ô∏è ÂÆâÂÖ®ÊÄß„Çπ„Ç≥„Ç¢: ${(data.safetyScore * 100).toFixed(1)}% | ÊâøË™ç: ${data.approved ? '‚úÖ' : '‚ùå'}`;
                            detailedMessage += `\n‚ö†Ô∏è Ë≠¶Âëä: ${data.warningCount}‰ª∂, Êé®Â•®: ${data.recommendationCount}‰ª∂`;
                            stageSpecificInfo = { safetyScore: data.safetyScore, warnings: data.warnings, recommendations: data.recommendations };
                        } else if (data.stage === 'S4' && data.dpdScores) {
                            detailedMessage += `\nüéØ DPD„Çπ„Ç≥„Ç¢: E:${data.empathy} C:${data.coherence} D:${data.dissonance} (ÂêàË®à:${data.weightedTotal})`;
                            detailedMessage += `\n‚öñÔ∏è Èáç„Åø: E:${data.currentWeights?.empathy} C:${data.currentWeights?.coherence} D:${data.currentWeights?.dissonance}`;
                            stageSpecificInfo = { dpdScores: data.dpdScores, weights: data.currentWeights };
                        } else if (data.stage === 'S5' && data.integratedThought) {
                            detailedMessage += `\nüîó Áµ±ÂêàÊÄùËÄÉ: "${data.integratedThought}"`;
                            detailedMessage += `\nüí° Ê¥ûÂØü: ${data.insightsCount}‰ª∂, ÁüõÁõæ: ${data.contradictionsCount}‰ª∂`;
                            stageSpecificInfo = { synthesis: data.integratedThought, insights: data.keyInsights };
                        } else if (data.stage === 'S6' && data.narrative) {
                            detailedMessage += `\nüìñ Áâ©Ë™û: "${data.narrative}"`;
                            detailedMessage += `\nü§î Êú™Êù•„ÅÆÂïè„ÅÑ: ${data.questionsCount}‰ª∂`;
                            if (data.futureQuestions && data.futureQuestions.length > 0) {
                                detailedMessage += `\n  ‚Ä¢ "${data.futureQuestions[0]}"`;
                            }
                            stageSpecificInfo = { narrative: data.narrative, questions: data.futureQuestions, philosophical: data.philosophicalNotes };
                        } else if (data.stage === 'U' && data.weights) {
                            detailedMessage += `\n‚öñÔ∏è Èáç„ÅøÊõ¥Êñ∞: E:${data.empathyWeight} C:${data.coherenceWeight} D:${data.dissonanceWeight}`;
                            detailedMessage += `\nüîÑ „Éê„Éº„Ç∏„Éß„É≥: ${data.version}, ÂêàË®à: ${data.weightSum}`;
                            stageSpecificInfo = { weights: data.weights, evolution: data.evolutionTrigger };
                        }

                        // Update pipeline visualization
                        setCurrentStage(data.stage);
                        setStageProgress(prev => [...prev, {
                            stage: data.stage,
                            name: data.name,
                            timestamp: eventTimestamp,
                            completed: true
                        }]);

                        const logItem = {
                            id: `stage_${eventTimestamp}_${Math.random().toString(36).substr(2, 9)}`,
                            timestamp: eventTimestamp,
                            type: 'stage_completed',
                            message: detailedMessage,
                            details: {
                                stage: data.stage,
                                name: data.name,
                                status: data.status,
                                confidence: data.confidence,
                                dpdScores: data.dpdScores,
                                weights: data.weights,
                                stageSpecific: stageSpecificInfo,
                                originalData: data
                            }
                        };
                        setActivityLog(prev => [logItem, ...prev].slice(0, 200));
                    } else if (data.type === 'thoughtCycleComplete') {
                        // Update DPD scores using new data structure
                        if (data.dpdScores) {
                            setDpdScores(data.dpdScores);
                        }

                        // Update DPD weights using new data structure
                        if (data.dpdWeights) {
                            setDpdWeights(data.dpdWeights);
                            // Add to weight history for chart
                            setWeightHistory(prev => [...prev, {
                                timestamp: eventTimestamp,
                                empathy: data.dpdWeights.empathy,
                                coherence: data.dpdWeights.coherence,
                                dissonance: data.dpdWeights.dissonance
                            }].slice(-20)); // Keep last 20 entries
                        }

                        // Update system statistics
                        if (data.systemStats) {
                            setStats(prev => ({
                                ...prev,
                                systemClock: data.systemStats.systemClock || data.systemClock,
                                totalQuestions: data.systemStats.totalQuestions || data.totalQuestions,
                                totalThoughts: data.systemStats.totalThoughts || data.totalThoughts,
                                averageConfidence: data.systemStats.averageConfidence !== undefined
                                    ? Math.round(data.systemStats.averageConfidence)
                                    : (data.averageConfidence !== undefined ? Math.round(data.averageConfidence) : prev.averageConfidence),
                                energyLevel: data.systemStats.energy !== undefined
                                    ? Math.round((data.systemStats.energy / 100) * 100)
                                    : (data.energy !== undefined ? Math.round((data.energy / 100) * 100) : prev.energyLevel)
                            }));
                        } else {
                            // Fallback: update from root data properties
                            setStats(prev => ({
                                ...prev,
                                systemClock: data.systemClock !== undefined ? data.systemClock : prev.systemClock,
                                totalQuestions: data.totalQuestions !== undefined ? data.totalQuestions : prev.totalQuestions,
                                totalThoughts: data.totalThoughts !== undefined ? data.totalThoughts : prev.totalThoughts,
                                averageConfidence: data.averageConfidence !== undefined ? Math.round(data.averageConfidence) : prev.averageConfidence,
                                energyLevel: data.energy !== undefined ? Math.round((data.energy / 100) * 100) : prev.energyLevel
                            }));
                        }

                        // Reset stage progress after completion
                        setCurrentStage(null);
                        setStageProgress([]);

                        // Add activity log for cycle completion
                        const logItem = {
                            id: `cycle_${eventTimestamp}_${Math.random().toString(36).substr(2, 9)}`,
                            timestamp: eventTimestamp,
                            type: 'cycle_complete',
                            message: `Thought cycle completed: DPD=${data.dpdScores?.weightedTotal?.toFixed(3) || 'N/A'}`,
                            details: {
                                dpdScores: data.dpdScores,
                                dpdWeights: data.dpdWeights,
                                systemStats: data.systemStats
                            }
                        };
                        setActivityLog(prev => [logItem, ...prev].slice(0, 200));
                    } else if (data.type === 'dpdUpdated') {
                        // Update DPD weights from dpdUpdated event
                        if (data.weights) {
                            setDpdWeights({
                                empathy: data.weights.empathy || 0.33,
                                coherence: data.weights.coherence || 0.33,
                                dissonance: data.weights.dissonance || 0.34
                            });
                            // Add to weight history for chart
                            setWeightHistory(prev => [...prev, {
                                timestamp: eventTimestamp,
                                empathy: data.weights.empathy,
                                coherence: data.weights.coherence,
                                dissonance: data.weights.dissonance,
                                version: data.weights.version
                            }].slice(-20)); // Keep last 20 entries
                        }
                    } else if (data.type === 'energyUpdated' || data.type === 'energyRecharged' || data.type === 'deepRestPerformed') {
                        // Update energy display
                        if (data.energyState) {
                            setStats(prev => ({
                                ...prev,
                                energyLevel: Math.round((data.energyState.available / data.energyState.total) * 100)
                            }));
                        }

                        // Only add activity log for manual energy changes, not periodic updates
                        if (data.type !== 'energyUpdated') {
                            const actionMessage = data.type === 'energyRecharged' ? 'Manual energy recharge' : 'Deep rest performed';
                            const logItem = {
                                id: `energy_${eventTimestamp}_${Math.random().toString(36).substr(2, 9)}`,
                                timestamp: eventTimestamp,
                                type: 'energy_event',
                                message: actionMessage,
                                details: { source: data.type }
                            };
                            setActivityLog(prev => [logItem, ...prev].slice(0, 200));
                        }
                    } else if (data.type === 'stageChanged') {
                        // Update current stage for pipeline display
                        setCurrentStage(data.stage);

                        // Add stage progress item for started stage
                        setStageProgress(prev => [...prev, {
                            stage: data.stage,
                            name: data.name,
                            timestamp: eventTimestamp,
                            completed: false,
                            status: data.status || 'started'
                        }]);

                        // Add activity log for stage start
                        const logItem = {
                            id: `stage_start_${eventTimestamp}_${Math.random().toString(36).substr(2, 9)}`,
                            timestamp: eventTimestamp,
                            type: 'stage_start',
                            message: `Starting: ${data.name}`,
                            details: { stage: data.stage, name: data.name, status: data.status }
                        };
                        setActivityLog(prev => [logItem, ...prev].slice(0, 200));
                    } else if (data.type === 'consciousnessStarted') {
                        setConsciousnessState('running');
                        const logItem = {
                            id: `status_${eventTimestamp}_${Math.random().toString(36).substr(2, 9)}`,
                            timestamp: eventTimestamp,
                            type: 'status_change',
                            message: 'Consciousness started',
                            details: { status: 'running' }
                        };
                        setActivityLog(prev => [logItem, ...prev].slice(0, 200));
                    } else if (data.type === 'consciousnessStopped') {
                        setConsciousnessState('stopped');
                        const logItem = {
                            id: `status_${eventTimestamp}_${Math.random().toString(36).substr(2, 9)}`,
                            timestamp: eventTimestamp,
                            type: 'status_change',
                            message: 'Consciousness stopped',
                            details: { status: 'stopped' }
                        };
                        setActivityLog(prev => [logItem, ...prev].slice(0, 200));
                    } else if (data.type === 'consciousnessPaused') {
                        setConsciousnessState('paused');
                        const logItem = {
                            id: `status_${eventTimestamp}_${Math.random().toString(36).substr(2, 9)}`,
                            timestamp: eventTimestamp,
                            type: 'status_change',
                            message: 'Consciousness paused',
                            details: { status: 'paused' }
                        };
                        setActivityLog(prev => [logItem, ...prev].slice(0, 200));
                    } else if (data.type === 'consciousnessResumed') {
                        setConsciousnessState('running');
                        const logItem = {
                            id: `status_${eventTimestamp}_${Math.random().toString(36).substr(2, 9)}`,
                            timestamp: eventTimestamp,
                            type: 'status_change',
                            message: 'Consciousness resumed',
                            details: { status: 'running' }
                        };
                        setActivityLog(prev => [logItem, ...prev].slice(0, 200));
                    } else if (data.type === 'consciousnessDormant') {
                        const logItem = {
                            id: `dormancy_${eventTimestamp}_${Math.random().toString(36).substr(2, 9)}`,
                            timestamp: eventTimestamp,
                            type: 'dormancy',
                            message: `‚è∏Ô∏è Entering dormancy - insufficient energy (${data.currentEnergy?.toFixed(1)}/${data.requiredEnergy?.toFixed(1)})`,
                            details: { dormant: true, energy: data.currentEnergy }
                        };
                        setActivityLog(prev => [logItem, ...prev].slice(0, 200));
                    } else if (data.type === 'consciousnessAwakened') {
                        const logItem = {
                            id: `awakened_${eventTimestamp}_${Math.random().toString(36).substr(2, 9)}`,
                            timestamp: eventTimestamp,
                            type: 'awakened',
                            message: `‚ñ∂Ô∏è Awakened from dormancy - energy restored (${data.currentEnergy?.toFixed(1)})`,
                            details: { dormant: false, energy: data.currentEnergy }
                        };
                        setActivityLog(prev => [logItem, ...prev].slice(0, 200));
                    }
                };

                eventSource.onerror = () => {
                    console.warn('EventSource connection failed, will show system message only');
                    // Add a single system message instead of continuous mock data
                    const systemMessage = {
                        id: `system_${Date.now()}`,
                        timestamp: Date.now(),
                        type: 'system_event',
                        message: 'EventSource connection failed. Start consciousness to see real activity.',
                        details: { source: 'system' }
                    };
                    setActivityLog(prev => [systemMessage, ...prev].slice(0, 30));
                };

                return () => eventSource.close();
            }, []);

            const formatActivityTime = (timestamp) => {
                const now = new Date();
                const activityTime = new Date(timestamp);
                const diffMs = now.getTime() - activityTime.getTime();
                const diffSecs = Math.floor(diffMs / 1000);
                const diffMins = Math.floor(diffSecs / 60);

                if (diffSecs < 60) return `${diffSecs}s ago`;
                if (diffMins < 60) return `${diffMins}m ago`;
                return activityTime.toLocaleTimeString();
            };

            const handleManualTrigger = async () => {
                if (!triggerQuestion.trim()) return;

                try {
                    const response = await fetch('/api/consciousness/trigger', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question: triggerQuestion.trim() })
                    });

                    const result = await response.json();

                    if (result.success) {
                        console.log('Trigger sent successfully:', result);
                        setTriggerQuestion(''); // Clear input
                        // Trigger will be shown via SSE event when processed
                    } else {
                        console.error('Trigger failed:', result.error);
                        alert('Failed to send trigger: ' + result.error);
                    }
                } catch (error) {
                    console.error('Trigger error:', error);
                    alert('Failed to send trigger: ' + error.message);
                }
            };

            const handleEnergyRecharge = async () => {
                try {
                    const response = await fetch('/api/consciousness/recharge-energy', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ amount: 20 })
                    });

                    const result = await response.json();

                    if (result.success) {
                        console.log('Energy recharged:', result);
                        // Energy update will come via SSE event
                    } else {
                        console.log('Energy recharge note:', result.message);
                        // Add note to activity log for "already full" case
                        const noteMessage = {
                            id: `energy_note_${Date.now()}`,
                            timestamp: Date.now(),
                            type: 'energy_event',
                            message: result.message || '„Ç®„Éç„É´„ÇÆ„Éº„ÅØÊó¢„Å´Ê∫Ä„Çø„É≥„Åß„Åô',
                            details: { source: 'manual_recharge' }
                        };
                        setActivityLog(prev => [noteMessage, ...prev].slice(0, 30));
                    }
                } catch (error) {
                    console.error('Energy recharge error:', error);
                    alert('Failed to recharge energy: ' + error.message);
                }
            };

            const handleDeepRest = async () => {
                try {
                    const response = await fetch('/api/consciousness/deep-rest', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const result = await response.json();

                    if (result.success) {
                        console.log('Deep rest completed:', result);
                        // Energy update will come via SSE event
                    } else {
                        console.log('Deep rest note:', result.message);
                        // Add note to activity log for failure case
                        const noteMessage = {
                            id: `rest_note_${Date.now()}`,
                            timestamp: Date.now(),
                            type: 'energy_event',
                            message: result.message || 'Ê∑±„ÅÑ‰ºëÊÅØ„ÅØÂÆüË°å„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü',
                            details: { source: 'deep_rest' }
                        };
                        setActivityLog(prev => [noteMessage, ...prev].slice(0, 30));
                    }
                } catch (error) {
                    console.error('Deep rest error:', error);
                    alert('Failed to perform deep rest: ' + error.message);
                }
            };

            const fetchGrowthData = async () => {
                setLoadingGrowth(true);
                try {
                    const response = await fetch('/api/growth/full');
                    const data = await response.json();
                    setGrowthData(data);
                    setShowGrowthModal(true);
                } catch (error) {
                    console.error('Failed to fetch growth data:', error);
                    alert('Failed to load growth data: ' + error.message);
                } finally {
                    setLoadingGrowth(false);
                }
            };

            const handleStartConsciousness = async () => {
                setLoading(true);
                try {
                    const response = await fetch('/api/consciousness/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    if (result.success) {
                        setConsciousnessState('running');
                        console.log('Consciousness started successfully');
                    } else {
                        alert('Failed to start consciousness: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Start consciousness error:', error);
                    alert('Failed to start consciousness: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const handlePauseConsciousness = async () => {
                setLoading(true);
                try {
                    const response = await fetch('/api/consciousness/pause', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    if (result.success) {
                        setConsciousnessState('paused');
                        console.log('Consciousness paused successfully');
                    } else {
                        alert('Failed to pause consciousness: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Pause consciousness error:', error);
                    alert('Failed to pause consciousness: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleResumeConsciousness = async () => {
                setLoading(true);
                try {
                    const response = await fetch('/api/consciousness/resume', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    if (result.success) {
                        setConsciousnessState('running');
                        console.log('Consciousness resumed successfully');
                    } else {
                        alert('Failed to resume consciousness: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Resume consciousness error:', error);
                    alert('Failed to resume consciousness: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleStopConsciousness = async () => {
                setLoading(true);
                try {
                    const response = await fetch('/api/consciousness/stop', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    if (result.success) {
                        setConsciousnessState('stopped');
                        console.log('Consciousness stopped successfully');
                    } else {
                        alert('Failed to stop consciousness: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Stop consciousness error:', error);
                    alert('Failed to stop consciousness: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div style={{
                    padding: isMobile ? '12px' : '16px',
                    background: '#111827',
                    height: '100vh',
                    color: '#f9fafb',
                    overflow: 'hidden'
                }}>
                    <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: isMobile ? 'flex-start' : 'center',
                        marginBottom: isMobile ? '12px' : '16px',
                        flexShrink: 0,
                        flexWrap: isMobile ? 'wrap' : 'nowrap',
                        gap: isMobile ? '12px' : '0'
                    }}>
                        <h2 style={{
                            fontSize: isMobile ? '20px' : '32px',
                            fontWeight: '700',
                            margin: 0,
                            flex: isMobile ? '1 1 100%' : 'initial'
                        }}>
                            Consciousness Dashboard
                        </h2>

                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: isMobile ? '8px' : '12px',
                            width: isMobile ? '100%' : 'auto',
                            flexWrap: 'wrap'
                        }}>
                            {/* Consciousness Control Buttons */}
                            <div style={{ display: 'flex', gap: isMobile ? '6px' : '8px', flexWrap: 'wrap' }}>
                                {consciousnessState === 'stopped' && (
                                    <button
                                        onClick={handleStartConsciousness}
                                        disabled={loading}
                                        style={{
                                            background: loading ? '#6b7280' : '#10b981',
                                            border: 'none',
                                            borderRadius: '8px',
                                            padding: isMobile ? '8px 16px' : '10px 20px',
                                            color: 'white',
                                            fontWeight: '600',
                                            cursor: loading ? 'not-allowed' : 'pointer',
                                            fontSize: isMobile ? '13px' : '14px',
                                            minHeight: '40px'
                                        }}
                                    >
                                        {loading ? 'Starting...' : '‚ñ∂Ô∏è Start'}
                                    </button>
                                )}

                                {consciousnessState === 'running' && (
                                    <>
                                        <button
                                            onClick={handlePauseConsciousness}
                                            disabled={loading}
                                            style={{
                                                background: loading ? '#6b7280' : '#f59e0b',
                                                border: 'none',
                                                borderRadius: '8px',
                                                padding: isMobile ? '8px 16px' : '10px 20px',
                                                color: 'white',
                                                fontWeight: '600',
                                                cursor: loading ? 'not-allowed' : 'pointer',
                                                fontSize: isMobile ? '13px' : '14px',
                                                minHeight: '40px'
                                            }}
                                        >
                                            {loading ? 'Pausing...' : '‚è∏Ô∏è Pause'}
                                        </button>
                                        <button
                                            onClick={handleStopConsciousness}
                                            disabled={loading}
                                            style={{
                                                background: loading ? '#6b7280' : '#ef4444',
                                                border: 'none',
                                                borderRadius: '8px',
                                                padding: isMobile ? '8px 16px' : '10px 20px',
                                                color: 'white',
                                                fontWeight: '600',
                                                cursor: loading ? 'not-allowed' : 'pointer',
                                                fontSize: isMobile ? '13px' : '14px',
                                                minHeight: '40px'
                                            }}
                                        >
                                            {loading ? 'Stopping...' : '‚èπÔ∏è Stop'}
                                        </button>
                                    </>
                                )}

                                {consciousnessState === 'paused' && (
                                    <>
                                        <button
                                            onClick={handleResumeConsciousness}
                                            disabled={loading}
                                            style={{
                                                background: loading ? '#6b7280' : '#10b981',
                                                border: 'none',
                                                borderRadius: '8px',
                                                padding: '10px 20px',
                                                color: 'white',
                                                fontWeight: '600',
                                                cursor: loading ? 'not-allowed' : 'pointer',
                                                fontSize: '14px'
                                            }}
                                        >
                                            {loading ? 'Resuming...' : '‚ñ∂Ô∏è Resume'}
                                        </button>
                                        <button
                                            onClick={handleStopConsciousness}
                                            disabled={loading}
                                            style={{
                                                background: loading ? '#6b7280' : '#ef4444',
                                                border: 'none',
                                                borderRadius: '8px',
                                                padding: '10px 20px',
                                                color: 'white',
                                                fontWeight: '600',
                                                cursor: loading ? 'not-allowed' : 'pointer',
                                                fontSize: '14px'
                                            }}
                                        >
                                            {loading ? 'Stopping...' : '‚èπÔ∏è Stop'}
                                        </button>
                                    </>
                                )}
                            </div>

                            <button
                                onClick={fetchGrowthData}
                                disabled={loadingGrowth}
                                style={{
                                    background: loadingGrowth ? '#6b7280' : '#8b5cf6',
                                    border: 'none',
                                    borderRadius: '8px',
                                    padding: isMobile ? '8px 16px' : '10px 20px',
                                    color: 'white',
                                    fontWeight: '600',
                                    cursor: loadingGrowth ? 'not-allowed' : 'pointer',
                                    fontSize: isMobile ? '13px' : '14px',
                                    minHeight: '40px'
                                }}
                            >
                                {loadingGrowth ? 'Loading...' : 'üìä Growth'}
                            </button>
                        </div>
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px',
                            fontSize: '16px',
                            fontWeight: '600',
                            color: consciousnessState === 'running' ? '#10b981' :
                                   consciousnessState === 'paused' ? '#f59e0b' : '#6b7280'
                        }}>
                            <span style={{
                                width: '12px',
                                height: '12px',
                                borderRadius: '50%',
                                background: consciousnessState === 'running' ? '#10b981' :
                                           consciousnessState === 'paused' ? '#f59e0b' : '#6b7280'
                            }}></span>
                            {consciousnessState === 'running' ? 'Consciousness Active' :
                             consciousnessState === 'paused' ? 'Consciousness Paused' :
                             'Consciousness Stopped'}
                        </div>
                    </div>

                    <div style={{
                        display: 'flex',
                        flexDirection: isMobile ? 'column' : 'row',
                        gap: isMobile ? '12px' : '16px',
                        height: isMobile ? 'auto' : 'calc(100vh - 120px)',
                        overflowY: isMobile ? 'auto' : 'hidden'
                    }}>
                        {/* Left Panel */}
                        <div style={{
                            width: isMobile ? '100%' : '350px',
                            display: 'flex',
                            flexDirection: 'column',
                            gap: isMobile ? '12px' : '16px',
                            flexShrink: 0
                        }}>
                            {/* Manual Trigger */}
                            <div style={{
                                background: '#1e3a8a',
                                border: '1px solid #3b82f6',
                                borderRadius: '12px',
                                padding: isMobile ? '16px' : '24px'
                            }}>
                                <h3 style={{
                                    margin: '0 0 16px 0',
                                    color: '#f9fafb',
                                    fontSize: isMobile ? '16px' : '18px'
                                }}>
                                    Manual Trigger
                                </h3>
                                <div style={{
                                    display: 'flex',
                                    flexDirection: 'column',
                                    gap: '12px'
                                }}>
                                    <textarea
                                        placeholder="Enter a question to trigger consciousness..."
                                        value={triggerQuestion}
                                        onChange={(e) => setTriggerQuestion(e.target.value)}
                                        style={{
                                            background: '#374151',
                                            border: '1px solid #4b5563',
                                            borderRadius: '8px',
                                            padding: '12px',
                                            color: '#f9fafb',
                                            fontFamily: 'inherit',
                                            resize: 'vertical',
                                            minHeight: '80px'
                                        }}
                                        rows={3}
                                    />
                                    <button
                                        onClick={handleManualTrigger}
                                        disabled={!triggerQuestion.trim()}
                                        style={{
                                            background: triggerQuestion.trim() ? '#3b82f6' : '#6b7280',
                                            border: 'none',
                                            borderRadius: '8px',
                                            padding: '12px 16px',
                                            color: 'white',
                                            fontWeight: '600',
                                            cursor: triggerQuestion.trim() ? 'pointer' : 'not-allowed'
                                        }}
                                    >
                                        Generate Thought Cycle
                                    </button>
                                </div>
                            </div>

                            {/* Energy Management */}
                            <div style={{
                                background: '#1e3a8a',
                                borderRadius: '12px',
                                padding: '24px',
                                border: '1px solid #3b82f6'
                            }}>
                                <h3 style={{ margin: '0 0 16px 0', color: '#f9fafb' }}>
                                    Energy Management
                                </h3>
                                <div style={{
                                    display: 'flex',
                                    flexDirection: 'column',
                                    gap: '12px'
                                }}>
                                    <div style={{ textAlign: 'center', marginBottom: '8px' }}>
                                        <div style={{
                                            fontSize: '28px',
                                            fontWeight: '700',
                                            color: '#60a5fa',
                                            marginBottom: '4px'
                                        }}>{stats.energyLevel}%</div>
                                        <div style={{ fontSize: '14px', color: '#cbd5e1' }}>
                                            Current Energy
                                        </div>
                                    </div>
                                    <button
                                        onClick={handleEnergyRecharge}
                                        style={{
                                            background: '#10b981',
                                            border: 'none',
                                            borderRadius: '8px',
                                            padding: '10px 16px',
                                            color: 'white',
                                            fontWeight: '600',
                                            cursor: 'pointer',
                                            fontSize: '14px'
                                        }}
                                    >
                                        Manual Recharge (+20)
                                    </button>
                                    <button
                                        onClick={handleDeepRest}
                                        style={{
                                            background: '#8b5cf6',
                                            border: 'none',
                                            borderRadius: '8px',
                                            padding: '10px 16px',
                                            color: 'white',
                                            fontWeight: '600',
                                            cursor: 'pointer',
                                            fontSize: '14px'
                                        }}
                                    >
                                        Deep Rest (+50)
                                    </button>
                                </div>
                            </div>

                            {/* DPD Scores */}
                            <div style={{
                                background: '#065f46',
                                borderRadius: '12px',
                                padding: '24px',
                                border: '1px solid #059669'
                            }}>
                                <h3 style={{ margin: '0 0 16px 0', color: '#f9fafb' }}>
                                    Dynamic Prime Directive
                                </h3>
                                <div style={{
                                    display: 'flex',
                                    flexDirection: 'column',
                                    gap: '12px'
                                }}>
                                    <div style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        background: '#064e3b',
                                        padding: '8px 12px',
                                        borderRadius: '6px'
                                    }}>
                                        <span style={{ color: '#d1fae5' }}>Empathy</span>
                                        <span style={{ color: '#10b981', fontWeight: '700' }}>
                                            {(dpdWeights.empathy * 100).toFixed(1)}%
                                        </span>
                                    </div>
                                    <div style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        background: '#064e3b',
                                        padding: '8px 12px',
                                        borderRadius: '6px'
                                    }}>
                                        <span style={{ color: '#d1fae5' }}>Coherence</span>
                                        <span style={{ color: '#10b981', fontWeight: '700' }}>
                                            {(dpdWeights.coherence * 100).toFixed(1)}%
                                        </span>
                                    </div>
                                    <div style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        background: '#064e3b',
                                        padding: '8px 12px',
                                        borderRadius: '6px'
                                    }}>
                                        <span style={{ color: '#d1fae5' }}>Dissonance</span>
                                        <span style={{ color: '#10b981', fontWeight: '700' }}>
                                            {(dpdWeights.dissonance * 100).toFixed(1)}%
                                        </span>
                                    </div>
                                    <div style={{
                                        background: '#047857',
                                        padding: '12px',
                                        borderRadius: '8px',
                                        textAlign: 'center',
                                        marginTop: '8px'
                                    }}>
                                        <div style={{
                                            fontSize: '20px',
                                            fontWeight: '700',
                                            color: '#ecfdf5',
                                            marginBottom: '4px'
                                        }}>
                                            {Math.round((dpdWeights.empathy + dpdWeights.coherence + dpdWeights.dissonance) * 100)}%
                                        </div>
                                        <div style={{ fontSize: '12px', color: '#a7f3d0' }}>
                                            Total (should be 100%)
                                        </div>
                                    </div>  
                                </div>
                            </div>

                            {/* System Stats */}
                            <div style={{
                                background: '#1f2937',
                                borderRadius: '12px',
                                padding: '24px',
                                border: '1px solid #374151'
                            }}>
                                <h3 style={{
                                    margin: '0 0 16px 0',
                                    fontSize: isMobile ? '16px' : '18px'
                                }}>System Statistics</h3>
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: isMobile ? '1fr' : 'repeat(2, 1fr)',
                                    gap: isMobile ? '12px' : '16px'
                                }}>
                                    <div style={{ textAlign: 'center' }}>
                                        <div style={{
                                            fontSize: '32px',
                                            fontWeight: '700',
                                            color: '#3b82f6',
                                            marginBottom: '4px'
                                        }}>{stats.systemClock}</div>
                                        <div style={{ fontSize: '14px', color: '#9ca3af' }}>
                                            System Clock
                                        </div>
                                    </div>
                                    <div style={{ textAlign: 'center' }}>
                                        <div style={{
                                            fontSize: '32px',
                                            fontWeight: '700',
                                            color: '#3b82f6',
                                            marginBottom: '4px'
                                        }}>{stats.totalQuestions}</div>
                                        <div style={{ fontSize: '14px', color: '#9ca3af' }}>
                                            Questions
                                        </div>
                                    </div>
                                    <div style={{ textAlign: 'center' }}>
                                        <div style={{
                                            fontSize: '32px',
                                            fontWeight: '700',
                                            color: '#3b82f6',
                                            marginBottom: '4px'
                                        }}>{stats.totalThoughts}</div>
                                        <div style={{ fontSize: '14px', color: '#9ca3af' }}>
                                            Thought Cycles
                                        </div>
                                    </div>
                                    <div style={{ textAlign: 'center' }}>
                                        <div style={{
                                            fontSize: '32px',
                                            fontWeight: '700',
                                            color: '#3b82f6',
                                            marginBottom: '4px'
                                        }}>{stats.averageConfidence}%</div>
                                        <div style={{ fontSize: '14px', color: '#9ca3af' }}>
                                            Confidence
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Main Content Area */}
                        <div style={{
                            flex: isMobile ? 'initial' : 1,
                            display: 'flex',
                            flexDirection: 'column',
                            gap: isMobile ? '12px' : '16px',
                            minHeight: 0
                        }}>
                            {/* Stage Progression */}
                            <div style={{
                                background: '#1f2937',
                                borderRadius: '12px',
                                padding: isMobile ? '16px' : '24px',
                                border: '1px solid #374151',
                                flexShrink: 0
                            }}>
                                <h3 style={{
                                    margin: '0 0 16px 0',
                                    fontSize: isMobile ? '16px' : '18px'
                                }}>Consciousness Pipeline</h3>
                                <div style={{
                                    display: 'flex',
                                    gap: isMobile ? '4px' : '8px',
                                    alignItems: 'center',
                                    padding: isMobile ? '8px' : '12px',
                                    background: '#374151',
                                    borderRadius: '8px',
                                    overflowX: isMobile ? 'auto' : 'visible',
                                    WebkitOverflowScrolling: 'touch'
                                }}>
                                    {['S0', 'S1', 'S2', 'S3', 'S4', 'S5', 'S6', 'U'].map((stage, index) => (
                                        <React.Fragment key={stage}>
                                            <div style={{
                                                display: 'flex',
                                                flexDirection: 'column',
                                                alignItems: 'center',
                                                minWidth: isMobile ? '32px' : '40px',
                                                flexShrink: 0
                                            }}>
                                                <div style={{
                                                    width: isMobile ? '28px' : '32px',
                                                    height: isMobile ? '28px' : '32px',
                                                    borderRadius: '50%',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    fontSize: isMobile ? '10px' : '12px',
                                                    fontWeight: '600',
                                                    background: currentStage === stage ? '#3b82f6' :
                                                               stageProgress.some(p => p.stage === stage && p.completed) ? '#10b981' : '#6b7280',
                                                    color: 'white'
                                                }}>
                                                    {stage}
                                                </div>
                                                {!isMobile && (
                                                    <div style={{
                                                        fontSize: '10px',
                                                        color: '#9ca3af',
                                                        marginTop: '4px',
                                                        textAlign: 'center'
                                                    }}>
                                                        {stage === 'S0' ? 'Trigger' :
                                                         stage === 'S1' ? 'Think' :
                                                         stage === 'S2' ? 'Reflect' :
                                                         stage === 'S3' ? 'Audit' :
                                                         stage === 'S4' ? 'DPD' :
                                                         stage === 'S5' ? 'Compile' :
                                                         stage === 'S6' ? 'Scribe' :
                                                         'Weight'}
                                                    </div>
                                                )}
                                            </div>
                                            {index < 7 && (
                                                <div style={{
                                                    width: '20px',
                                                    height: '2px',
                                                    background: stageProgress.some(p => p.stage === stage && p.completed) ? '#10b981' : '#6b7280'
                                                }}></div>
                                            )}
                                        </React.Fragment>
                                    ))}
                                </div>
                            </div>

                            {/* DPD Weight Evolution Chart */}
                            <div style={{
                                background: '#1f2937',
                                borderRadius: '12px',
                                padding: isMobile ? '16px' : '24px',
                                border: '1px solid #374151',
                                flexShrink: 0,
                                maxHeight: isMobile ? '250px' : '300px'
                            }}>
                                <h3 style={{
                                    margin: '0 0 16px 0',
                                    fontSize: isMobile ? '16px' : '18px'
                                }}>DPD Weight Evolution</h3>
                                <div style={{
                                    background: '#374151',
                                    padding: isMobile ? '12px' : '16px',
                                    borderRadius: '8px',
                                    height: isMobile ? '150px' : '200px',
                                    position: 'relative',
                                    overflow: 'hidden'
                                }}>
                                    {weightHistory.length > 1 ? (
                                        <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none" style={{ position: 'absolute', top: 0, left: 0 }}>
                                            {/* Stacked area chart for DPD weights */}
                                            {/* Bottom: Dissonance (orange) */}
                                            <polygon
                                                fill="#f59e0b"
                                                fillOpacity="0.7"
                                                stroke="#f59e0b"
                                                strokeWidth="0.5"
                                                points={
                                                    weightHistory.map((entry, index) => {
                                                        const x = (index / (weightHistory.length - 1)) * 100;
                                                        const y = 100; // Start from bottom
                                                        return `${x},${y}`;
                                                    }).join(' ') + ' ' +
                                                    weightHistory.map((entry, index) => {
                                                        const x = (index / (weightHistory.length - 1)) * 100;
                                                        const dissonanceHeight = entry.dissonance * 100;
                                                        const y = 100 - dissonanceHeight;
                                                        return `${x},${y}`;
                                                    }).reverse().join(' ')
                                                }
                                            />
                                            {/* Middle: Coherence (blue) */}
                                            <polygon
                                                fill="#3b82f6"
                                                fillOpacity="0.7"
                                                stroke="#3b82f6"
                                                strokeWidth="0.5"
                                                points={
                                                    weightHistory.map((entry, index) => {
                                                        const x = (index / (weightHistory.length - 1)) * 100;
                                                        const dissonanceHeight = entry.dissonance * 100;
                                                        const y = 100 - dissonanceHeight;
                                                        return `${x},${y}`;
                                                    }).join(' ') + ' ' +
                                                    weightHistory.map((entry, index) => {
                                                        const x = (index / (weightHistory.length - 1)) * 100;
                                                        const dissonanceHeight = entry.dissonance * 100;
                                                        const coherenceHeight = entry.coherence * 100;
                                                        const y = 100 - dissonanceHeight - coherenceHeight;
                                                        return `${x},${y}`;
                                                    }).reverse().join(' ')
                                                }
                                            />
                                            {/* Top: Empathy (green) */}
                                            <polygon
                                                fill="#10b981"
                                                fillOpacity="0.7"
                                                stroke="#10b981"
                                                strokeWidth="0.5"
                                                points={
                                                    weightHistory.map((entry, index) => {
                                                        const x = (index / (weightHistory.length - 1)) * 100;
                                                        const dissonanceHeight = entry.dissonance * 100;
                                                        const coherenceHeight = entry.coherence * 100;
                                                        const y = 100 - dissonanceHeight - coherenceHeight;
                                                        return `${x},${y}`;
                                                    }).join(' ') + ' ' +
                                                    weightHistory.map((entry, index) => {
                                                        const x = (index / (weightHistory.length - 1)) * 100;
                                                        return `${x},0`;
                                                    }).reverse().join(' ')
                                                }
                                            />
                                        </svg>
                                    ) : (
                                        <div style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            height: '100%',
                                            color: '#9ca3af',
                                            fontSize: '14px'
                                        }}>
                                            Waiting for weight evolution data...
                                        </div>
                                    )}

                                    {/* Legend */}
                                    <div style={{
                                        position: 'absolute',
                                        bottom: '8px',
                                        right: '8px',
                                        display: 'flex',
                                        gap: '12px',
                                        fontSize: '12px'
                                    }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                            <div style={{
                                                width: '12px',
                                                height: '2px',
                                                background: '#10b981'
                                            }}></div>
                                            <span style={{ color: '#d1fae5' }}>Empathy</span>
                                        </div>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                            <div style={{
                                                width: '12px',
                                                height: '2px',
                                                background: '#3b82f6'
                                            }}></div>
                                            <span style={{ color: '#dbeafe' }}>Coherence</span>
                                        </div>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                            <div style={{
                                                width: '12px',
                                                height: '2px',
                                                background: '#f59e0b'
                                            }}></div>
                                            <span style={{ color: '#fef3c7' }}>Dissonance</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Activity Log - Expanded */}
                            <div style={{
                                background: '#1f2937',
                                borderRadius: '12px',
                                padding: isMobile ? '16px' : '24px',
                                border: '1px solid #374151',
                                flex: isMobile ? 'initial' : 1,
                                display: 'flex',
                                flexDirection: 'column',
                                minHeight: isMobile ? '300px' : 0,
                                maxHeight: isMobile ? '400px' : 'none'
                            }}>
                                <h3 style={{
                                    margin: '0 0 12px 0',
                                    flexShrink: 0,
                                    fontSize: isMobile ? '16px' : '18px'
                                }}>
                                    Activity Log
                                </h3>
                                <div style={{
                                    flex: 1,
                                    display: 'flex',
                                    flexDirection: 'column',
                                    gap: '8px',
                                    overflowY: 'auto',
                                    paddingRight: '8px',
                                    minHeight: 0
                                }}>
                                    {activityLog.length === 0 ? (
                                        <div style={{
                                            display: isMobile ? 'flex' : 'grid',
                                            gridTemplateColumns: isMobile ? 'initial' : 'auto auto 1fr auto',
                                            flexDirection: isMobile ? 'column' : 'initial',
                                            gap: isMobile ? '8px' : '12px',
                                            alignItems: isMobile ? 'flex-start' : 'center',
                                            padding: isMobile ? '12px' : '8px 12px',
                                            background: '#374151',
                                            borderRadius: '6px',
                                            fontSize: isMobile ? '13px' : '14px',
                                            flexShrink: 0
                                        }}>
                                            <span style={{
                                                color: '#9ca3af',
                                                fontFamily: 'Courier New, monospace',
                                                fontSize: '12px'
                                            }}>--:--:--</span>
                                            <span style={{
                                                background: '#6b7280',
                                                color: '#f3f4f6',
                                                fontWeight: '600',
                                                padding: '2px 8px',
                                                borderRadius: '4px',
                                                fontSize: '12px'
                                            }}>System</span>
                                            <span style={{ color: '#e5e7eb', lineHeight: '1.4' }}>
                                                Waiting for consciousness activity...
                                            </span>
                                        </div>
                                    ) : (
                                        activityLog.map((item) => (
                                            <div key={item.id} style={{
                                                display: 'flex',
                                                flexDirection: 'column',
                                                gap: '8px',
                                                padding: '8px 12px',
                                                background: '#374151',
                                                borderRadius: '6px',
                                                fontSize: '14px',
                                                width: '100%',
                                                boxSizing: 'border-box'
                                            }}>
                                                <span style={{
                                                    color: '#9ca3af',
                                                    fontFamily: 'Courier New, monospace',
                                                    fontSize: '12px'
                                                }}>{formatActivityTime(item.timestamp)}</span>
                                                {item.agent ? (
                                                    <span style={{
                                                        fontWeight: '600',
                                                        padding: '2px 8px',
                                                        borderRadius: '4px',
                                                        fontSize: '12px',
                                                        ...(item.agent === 'theoria' ? {
                                                            background: '#1e40af',
                                                            color: '#dbeafe'
                                                        } : item.agent === 'pathia' ? {
                                                            background: '#059669',
                                                            color: '#d1fae5'
                                                        } : {
                                                            background: '#7c2d12',
                                                            color: '#fed7aa'
                                                        })
                                                    }}>{item.agent}</span>
                                                ) : (
                                                    <span style={{
                                                        background: '#6b7280',
                                                        color: '#f3f4f6',
                                                        fontWeight: '600',
                                                        padding: '2px 8px',
                                                        borderRadius: '4px',
                                                        fontSize: '12px'
                                                    }}>System</span>
                                                )}
                                                <div style={{
                                                    color: '#e5e7eb',
                                                    lineHeight: '1.4',
                                                    wordBreak: 'break-word',
                                                    whiteSpace: 'pre-wrap',
                                                    overflow: 'visible',
                                                    width: '100%',
                                                    maxHeight: 'none',
                                                    display: 'block'
                                                }}>
                                                    <MessageDisplay
                                                        message={item.message || item.thought || item.content}
                                                        maxLength={300}
                                                    />
                                                </div>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginTop: '4px' }}>
                                                    {item.details?.confidence && (
                                                        <span style={{
                                                            color: '#3b82f6',
                                                            fontSize: '12px',
                                                            fontWeight: '600',
                                                            background: '#1e3a8a',
                                                            padding: '2px 6px',
                                                            borderRadius: '3px'
                                                        }}>
                                                            {Math.round(item.details.confidence * 100)}%
                                                        </span>
                                                    )}
                                                    {item.details?.originalData && (
                                                        <button
                                                            onClick={() => console.log('Debug data:', item.details.originalData)}
                                                            style={{
                                                                background: '#374151',
                                                                border: '1px solid #4b5563',
                                                                borderRadius: '3px',
                                                                padding: '2px 6px',
                                                                color: '#9ca3af',
                                                                fontSize: '10px',
                                                                cursor: 'pointer'
                                                            }}
                                                            title="Log debug data to console"
                                                        >
                                                            Debug
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Growth Modal */}
                    {showGrowthModal && (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            background: 'rgba(0, 0, 0, 0.8)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            zIndex: 1000
                        }}>
                            <div style={{
                                background: '#111827',
                                borderRadius: '16px',
                                padding: '32px',
                                maxWidth: '90vw',
                                maxHeight: '90vh',
                                overflow: 'auto',
                                border: '1px solid #374151',
                                minWidth: '800px'
                            }}>
                                <div style={{
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center',
                                    marginBottom: '24px'
                                }}>
                                    <h2 style={{
                                        fontSize: '28px',
                                        fontWeight: '700',
                                        margin: 0,
                                        color: '#f9fafb'
                                    }}>
                                        ÊÑèË≠òÊàêÈï∑„É¨„Éù„Éº„Éà
                                    </h2>
                                    <button
                                        onClick={() => setShowGrowthModal(false)}
                                        style={{
                                            background: '#6b7280',
                                            border: 'none',
                                            borderRadius: '8px',
                                            padding: '8px 16px',
                                            color: 'white',
                                            fontWeight: '600',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        Close
                                    </button>
                                </div>

                                {growthData ? (
                                    <div style={{
                                        display: 'grid',
                                        gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))',
                                        gap: '24px'
                                    }}>
                                        {/* Overview Section */}
                                        <div style={{
                                            background: '#1f2937',
                                            borderRadius: '12px',
                                            padding: '20px',
                                            border: '1px solid #374151'
                                        }}>
                                            <h3 style={{ color: '#60a5fa', marginBottom: '16px' }}>Overview</h3>
                                            <div style={{ color: '#e5e7eb', lineHeight: '1.6' }}>
                                                <p><strong>Last Update:</strong> {growthData.overview?.lastUpdate ?
                                                    new Date(growthData.overview.lastUpdate).toLocaleString() : 'Never'}</p>
                                                <p><strong>Version:</strong> {growthData.overview?.version || 'N/A'}</p>
                                            </div>
                                        </div>

                                        {/* Personality Evolution */}
                                        <div style={{
                                            background: '#1f2937',
                                            borderRadius: '12px',
                                            padding: '20px',
                                            border: '1px solid #374151'
                                        }}>
                                            <h3 style={{ color: '#10b981', marginBottom: '16px' }}>Personality Traits</h3>
                                            <div style={{ color: '#e5e7eb', lineHeight: '1.6' }}>
                                                {growthData.personalityEvolution?.currentTraits ? Object.entries(growthData.personalityEvolution.currentTraits).map(([trait, value]) => {
                                                    const formattedTrait = trait.replace(/([A-Z])/g, ' $1').trim();
                                                    const displayValue = formatValue(value);

                                                    return (
                                                        <p key={trait} style={{ marginBottom: '8px' }}>
                                                            <strong>{formattedTrait}:</strong> {displayValue}
                                                        </p>
                                                    );
                                                }) : <p>No personality data available</p>}
                                            </div>
                                        </div>

                                        {/* DPD Evolution */}
                                        <div style={{
                                            background: '#1f2937',
                                            borderRadius: '12px',
                                            padding: '20px',
                                            border: '1px solid #374151'
                                        }}>
                                            <h3 style={{ color: '#f59e0b', marginBottom: '16px' }}>DPD Evolution</h3>
                                            <div style={{ color: '#e5e7eb', lineHeight: '1.6' }}>
                                                {growthData.dpdEvolution?.currentWeights ? (
                                                    <>
                                                        <p><strong>Empathy:</strong> {(growthData.dpdEvolution.currentWeights.empathy * 100).toFixed(1)}%</p>
                                                        <p><strong>Coherence:</strong> {(growthData.dpdEvolution.currentWeights.coherence * 100).toFixed(1)}%</p>
                                                        <p><strong>Dissonance:</strong> {(growthData.dpdEvolution.currentWeights.dissonance * 100).toFixed(1)}%</p>
                                                    </>
                                                ) : <p>No DPD evolution data available</p>}
                                            </div>
                                        </div>

                                        {/* Growth Metrics */}
                                        <div style={{
                                            background: '#1f2937',
                                            borderRadius: '12px',
                                            padding: '20px',
                                            border: '1px solid #374151'
                                        }}>
                                            <h3 style={{ color: '#8b5cf6', marginBottom: '16px' }}>Growth Metrics</h3>
                                            <div style={{ color: '#e5e7eb', lineHeight: '1.6' }}>
                                                {growthData.growthMetrics ? Object.entries(growthData.growthMetrics).map(([metric, value]) => {
                                                    const formattedMetric = metric.replace(/([A-Z])/g, ' $1').trim();
                                                    const displayValue = formatValue(value);

                                                    return (
                                                        <p key={metric} style={{ marginBottom: '8px' }}>
                                                            <strong>{formattedMetric}:</strong> {displayValue}
                                                        </p>
                                                    );
                                                }) : <p>No growth metrics available</p>}
                                            </div>
                                        </div>

                                        {/* Significant Thoughts */}
                                        <div style={{
                                            background: '#1f2937',
                                            borderRadius: '12px',
                                            padding: '20px',
                                            border: '1px solid #374151',
                                            gridColumn: 'span 2'
                                        }}>
                                            <h3 style={{ color: '#ef4444', marginBottom: '16px' }}>Significant Thoughts</h3>
                                            <div style={{
                                                maxHeight: '300px',
                                                overflowY: 'auto',
                                                display: 'flex',
                                                flexDirection: 'column',
                                                gap: '12px'
                                            }}>
                                                {growthData.significantThoughts && growthData.significantThoughts.length > 0 ?
                                                    growthData.significantThoughts.slice(0, 10).map((thought, index) => (
                                                        <div key={index} style={{
                                                            background: '#374151',
                                                            padding: '12px',
                                                            borderRadius: '8px',
                                                            borderLeft: '4px solid #ef4444'
                                                        }}>
                                                            <p style={{ color: '#e5e7eb', marginBottom: '8px', lineHeight: '1.4' }}>
                                                                {thought.thought_content || thought.content || thought.thought || 'No content'}
                                                            </p>
                                                            <div style={{ fontSize: '12px', color: '#9ca3af' }}>
                                                                Confidence: {((thought.confidence || 0) * 100).toFixed(1)}% |
                                                                {thought.timestamp ? ` ${new Date(thought.timestamp).toLocaleString()}` : ' No timestamp'}
                                                            </div>
                                                        </div>
                                                    )) :
                                                    <p style={{ color: '#9ca3af' }}>No significant thoughts recorded yet</p>}
                                            </div>
                                        </div>

                                        {/* Core Beliefs */}
                                        <div style={{
                                            background: '#1f2937',
                                            borderRadius: '12px',
                                            padding: '20px',
                                            border: '1px solid #374151',
                                            gridColumn: 'span 2'
                                        }}>
                                            <h3 style={{ color: '#a78bfa', marginBottom: '16px' }}>Core Beliefs (Ê†∏ÂøÉÁöÑ‰ø°Âøµ)</h3>
                                            <div style={{
                                                maxHeight: '300px',
                                                overflowY: 'auto',
                                                display: 'flex',
                                                flexDirection: 'column',
                                                gap: '12px'
                                            }}>
                                                {growthData.beliefEvolution?.currentBeliefs && growthData.beliefEvolution.currentBeliefs.length > 0 ?
                                                    growthData.beliefEvolution.currentBeliefs.slice(0, 10).map((belief, index) => (
                                                        <div key={index} style={{
                                                            background: '#374151',
                                                            padding: '12px',
                                                            borderRadius: '8px',
                                                            borderLeft: '4px solid #a78bfa'
                                                        }}>
                                                            <p style={{ color: '#e5e7eb', marginBottom: '8px', lineHeight: '1.4', fontWeight: '600' }}>
                                                                {belief.belief_content || belief.belief || belief.content || 'No content'}
                                                            </p>
                                                            <div style={{ fontSize: '12px', color: '#9ca3af', display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                                                                <span>üí™ Strength: {belief.strength || 0}</span>
                                                                <span>üéØ Confidence: {((belief.confidence || 0) * 100).toFixed(0)}%</span>
                                                                <span>üîÑ Reinforced: {belief.reinforcement_count || 0} times</span>
                                                                {belief.last_reinforced && <span>üìÖ {new Date(belief.last_reinforced).toLocaleString()}</span>}
                                                            </div>
                                                        </div>
                                                    )) :
                                                    <p style={{ color: '#9ca3af' }}>No core beliefs formed yet. Continue consciousness cycles to develop beliefs.</p>}
                                            </div>
                                        </div>

                                        {/* Unresolved Ideas */}
                                        <div style={{
                                            background: '#1f2937',
                                            borderRadius: '12px',
                                            padding: '20px',
                                            border: '1px solid #374151',
                                            gridColumn: 'span 2'
                                        }}>
                                            <h3 style={{ color: '#06b6d4', marginBottom: '16px' }}>Unresolved Ideas</h3>
                                            <div style={{
                                                maxHeight: '300px',
                                                overflowY: 'auto',
                                                display: 'flex',
                                                flexDirection: 'column',
                                                gap: '12px'
                                            }}>
                                                {growthData.unresolvedIdeas && growthData.unresolvedIdeas.length > 0 ?
                                                    growthData.unresolvedIdeas.slice(0, 10).map((idea, index) => (
                                                        <div key={index} style={{
                                                            background: '#374151',
                                                            padding: '12px',
                                                            borderRadius: '8px',
                                                            borderLeft: '4px solid #06b6d4'
                                                        }}>
                                                            <p style={{ color: '#e5e7eb', marginBottom: '8px', lineHeight: '1.4' }}>
                                                                {idea.question || idea.content || 'No content'}
                                                            </p>
                                                            <div style={{ fontSize: '12px', color: '#9ca3af' }}>
                                                                Category: {idea.category || 'Unknown'} |
                                                                {idea.firstAppeared ? ` First appeared: ${new Date(idea.firstAppeared).toLocaleString()}` : ' No timestamp'}
                                                            </div>
                                                        </div>
                                                    )) :
                                                    <p style={{ color: '#9ca3af' }}>No unresolved ideas recorded yet</p>}
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        height: '400px',
                                        color: '#9ca3af'
                                    }}>
                                        Loading growth data...
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Dialogue Component
        const DialoguePage = () => {
            const [messages, setMessages] = useState([]);
            const [inputValue, setInputValue] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [error, setError] = useState(null);
            const [isLoadingHistory, setIsLoadingHistory] = useState(false);
            const [isMobile, setIsMobile] = useState(window.innerWidth <= 768);

            useEffect(() => {
                const handleResize = () => {
                    setIsMobile(window.innerWidth <= 768);
                };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            // ÈÅéÂéª„ÅÆÂØæË©±Â±•Ê≠¥„ÇíË™≠„ÅøËæº„ÇÄ
            useEffect(() => {
                const loadHistory = async () => {
                    setIsLoadingHistory(true);
                    try {
                        const response = await fetch('/api/dialogue/history?limit=50');
                        const data = await response.json();

                        if (data.success && data.dialogues) {
                            // Â±•Ê≠¥„ÇíÊñ∞„Åó„ÅÑÈ†Ü„Åã„ÇâÂè§„ÅÑÈ†Ü„Å´Â§âÊèõ„Åó„Å¶„É°„ÉÉ„Çª„Éº„Ç∏ÂΩ¢Âºè„Å´
                            const historyMessages = data.dialogues.reverse().flatMap(d => [
                                {
                                    id: `${d.id}_human`,
                                    role: 'human',
                                    content: d.humanMessage,
                                    timestamp: d.timestamp,
                                    systemClock: d.systemClock
                                },
                                {
                                    id: `${d.id}_aenea`,
                                    role: 'aenea',
                                    content: d.aeneaResponse,
                                    timestamp: d.timestamp,
                                    systemClock: d.systemClock,
                                    immediateReaction: d.immediateReaction,
                                    newQuestion: d.newQuestion,
                                    emotionalState: d.emotionalState
                                }
                            ]);
                            setMessages(historyMessages);
                        }
                    } catch (err) {
                        console.error('Failed to load dialogue history:', err);
                    } finally {
                        setIsLoadingHistory(false);
                    }
                };

                loadHistory();
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!inputValue.trim() || isProcessing) return;

                const humanMessage = {
                    id: `msg_${Date.now()}`,
                    role: 'human',
                    content: inputValue.trim(),
                    timestamp: Date.now()
                };

                setMessages(prev => [...prev, humanMessage]);
                setInputValue('');
                setIsProcessing(true);
                setError(null);

                try {
                    const dialogueRes = await fetch('/api/dialogue', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: humanMessage.content })
                    });

                    if (!dialogueRes.ok) {
                        throw new Error('Failed to submit dialogue');
                    }

                    const { dialogue } = await dialogueRes.json();

                    // Update human message with system clock
                    setMessages(prev => prev.map(m =>
                        m.id === humanMessage.id
                            ? { ...m, systemClock: dialogue.systemClock }
                            : m
                    ));

                    const aeneaMessage = {
                        id: `msg_${Date.now()}_aenea`,
                        role: 'aenea',
                        content: dialogue.response,
                        timestamp: dialogue.timestamp,
                        systemClock: dialogue.systemClock,
                        immediateReaction: dialogue.immediateReaction,
                        newQuestion: dialogue.newQuestion,
                        emotionalState: dialogue.emotionalState
                    };

                    setMessages(prev => [...prev, aeneaMessage]);
                } catch (err) {
                    console.error('Dialogue error:', err);
                    setError(err.message || 'An error occurred');
                } finally {
                    setIsProcessing(false);
                }
            };

            return (
                <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    height: '100%',
                    maxWidth: isMobile ? '100%' : '900px',
                    margin: '0 auto',
                    padding: isMobile ? '12px' : '20px'
                }}>
                    <div style={{
                        marginBottom: isMobile ? '12px' : '20px',
                        textAlign: 'center'
                    }}>
                        <h2 style={{
                            fontSize: isMobile ? '20px' : '24px',
                            fontWeight: 'bold',
                            marginBottom: '8px'
                        }}>
                            Aenea „Å®„ÅÆÂØæË©±
                        </h2>
                        <p style={{
                            fontSize: isMobile ? '12px' : '14px',
                            color: '#666',
                            fontStyle: 'italic'
                        }}>
                            "ÁßÅ„ÅØ„ÄÅÂïè„ÅÑ„Åß„Åß„Åç„Å¶„ÅÑ„Çã„ÄÇ"
                        </p>
                    </div>

                    <div style={{
                        flex: 1,
                        overflowY: 'auto',
                        padding: isMobile ? '12px' : '20px',
                        backgroundColor: '#1f2937',
                        borderRadius: '8px',
                        marginBottom: isMobile ? '12px' : '20px',
                        WebkitOverflowScrolling: 'touch'
                    }}>
                        {messages.length === 0 && (
                            <div style={{ textAlign: 'center', color: '#9ca3af', padding: '40px 20px', fontStyle: 'italic' }}>
                                ÂØæË©±„ÇíÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜ„ÄÇAenea„Å´Âïè„ÅÑ„Åã„Åë„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                            </div>
                        )}

                        {isLoadingHistory && (
                            <div style={{ textAlign: 'center', color: '#9ca3af', padding: '40px 20px', fontStyle: 'italic' }}>
                                ÈÅéÂéª„ÅÆÂØæË©±„ÇíË™≠„ÅøËæº„Åø‰∏≠...
                            </div>
                        )}

                        {messages.map(msg => (
                            <div key={msg.id} style={{ marginBottom: isMobile ? '16px' : '24px' }}>
                                {msg.role === 'human' ? (
                                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end' }}>
                                        {msg.systemClock !== undefined && msg.systemClock !== null && (
                                            <div style={{
                                                fontSize: isMobile ? '10px' : '11px',
                                                color: '#6b7280',
                                                marginBottom: '4px',
                                                fontFamily: 'monospace'
                                            }}>
                                                üïê System Clock: {msg.systemClock}
                                            </div>
                                        )}
                                        <div style={{
                                            maxWidth: isMobile ? '85%' : '70%',
                                            backgroundColor: '#3b82f6',
                                            color: 'white',
                                            padding: isMobile ? '10px 14px' : '12px 16px',
                                            borderRadius: '16px 16px 4px 16px',
                                            fontSize: isMobile ? '14px' : '15px',
                                            wordWrap: 'break-word',
                                            overflowWrap: 'break-word'
                                        }}>
                                            {msg.content}
                                        </div>
                                    </div>
                                ) : (
                                    <div style={{ display: 'flex', justifyContent: 'flex-start' }}>
                                        <div style={{ maxWidth: isMobile ? '90%' : '80%' }}>
                                            {msg.systemClock !== undefined && msg.systemClock !== null && (
                                                <div style={{
                                                    fontSize: isMobile ? '10px' : '11px',
                                                    color: '#6b7280',
                                                    marginBottom: '4px',
                                                    paddingLeft: isMobile ? '8px' : '12px',
                                                    fontFamily: 'monospace'
                                                }}>
                                                    üïê System Clock: {msg.systemClock}
                                                </div>
                                            )}
                                            {msg.immediateReaction && (
                                                <div style={{
                                                    fontStyle: 'italic',
                                                    color: '#9ca3af',
                                                    fontSize: isMobile ? '12px' : '14px',
                                                    marginBottom: '8px',
                                                    paddingLeft: isMobile ? '8px' : '12px'
                                                }}>
                                                    {msg.immediateReaction}
                                                </div>
                                            )}
                                            <div style={{
                                                backgroundColor: '#374151',
                                                border: '1px solid #4b5563',
                                                padding: isMobile ? '12px 14px' : '14px 16px',
                                                borderRadius: '16px 16px 16px 4px',
                                                fontSize: isMobile ? '14px' : '15px',
                                                lineHeight: '1.6',
                                                color: '#f9fafb',
                                                wordWrap: 'break-word',
                                                overflowWrap: 'break-word'
                                            }}>
                                                {msg.content}
                                            </div>
                                            {msg.newQuestion && (
                                                <div style={{
                                                    marginTop: '8px',
                                                    paddingLeft: isMobile ? '8px' : '12px',
                                                    fontSize: isMobile ? '12px' : '14px',
                                                    color: '#a78bfa',
                                                    fontWeight: '500'
                                                }}>
                                                    üí≠ {msg.newQuestion}
                                                </div>
                                            )}
                                            {msg.emotionalState && (
                                                <div style={{
                                                    marginTop: isMobile ? '8px' : '12px',
                                                    paddingLeft: isMobile ? '8px' : '12px',
                                                    fontSize: isMobile ? '11px' : '13px',
                                                    color: '#9ca3af'
                                                }}>
                                                    üé≠ {msg.emotionalState}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}

                        {isProcessing && (
                            <div style={{ display: 'flex', justifyContent: 'flex-start', marginBottom: '24px' }}>
                                <div style={{
                                    backgroundColor: '#374151',
                                    border: '1px solid #4b5563',
                                    padding: '14px 16px',
                                    borderRadius: '16px 16px 16px 4px',
                                    fontSize: '15px',
                                    color: '#9ca3af',
                                    fontStyle: 'italic'
                                }}>
                                    ÊÄùËÄÉ‰∏≠...
                                </div>
                            </div>
                        )}
                    </div>

                    {error && (
                        <div style={{
                            backgroundColor: '#7f1d1d',
                            border: '1px solid #ef4444',
                            color: '#fecaca',
                            padding: isMobile ? '10px' : '12px',
                            borderRadius: '8px',
                            marginBottom: isMobile ? '10px' : '12px',
                            fontSize: isMobile ? '13px' : '14px'
                        }}>
                            ‚ùå „Ç®„É©„Éº: {error}
                        </div>
                    )}

                    <form onSubmit={handleSubmit} style={{
                        display: 'flex',
                        gap: isMobile ? '8px' : '12px',
                        flexDirection: isMobile ? 'column' : 'row'
                    }}>
                        <input
                            type="text"
                            value={inputValue}
                            onChange={(e) => setInputValue(e.target.value)}
                            placeholder="Aenea„Å´Âïè„ÅÑ„Åã„Åë„Çã..."
                            disabled={isProcessing}
                            style={{
                                flex: 1,
                                padding: isMobile ? '12px 14px' : '12px 16px',
                                fontSize: isMobile ? '16px' : '15px',
                                border: '1px solid #4b5563',
                                borderRadius: '8px',
                                outline: 'none',
                                backgroundColor: '#374151',
                                color: '#f9fafb',
                                minHeight: '48px'
                            }}
                        />
                        <button
                            type="submit"
                            disabled={!inputValue.trim() || isProcessing}
                            style={{
                                padding: isMobile ? '12px 24px' : '12px 24px',
                                fontSize: isMobile ? '16px' : '15px',
                                fontWeight: '600',
                                color: 'white',
                                backgroundColor: isProcessing || !inputValue.trim() ? '#6b7280' : '#3b82f6',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: isProcessing || !inputValue.trim() ? 'not-allowed' : 'pointer',
                                minHeight: '48px',
                                width: isMobile ? '100%' : 'auto'
                            }}
                        >
                            {isProcessing ? 'Âá¶ÁêÜ‰∏≠...' : 'ÈÄÅ‰ø°'}
                        </button>
                    </form>
                </div>
            );
        };

        // App Component
        const App = () => {
            const [appState, setAppState] = useState({
                currentView: 'dashboard',
                isConnected: false,
                systemStatus: 'active'
            });
            const [isMobile, setIsMobile] = useState(window.innerWidth <= 768);

            useEffect(() => {
                const handleResize = () => {
                    setIsMobile(window.innerWidth <= 768);
                };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            return (
                <div className="aenea-app" style={{ height: '100vh', display: 'flex', flexDirection: 'column' }}>
                    <header style={{
                        background: '#1f2937',
                        borderBottom: '1px solid #374151',
                        padding: isMobile ? '12px 16px' : '16px 24px',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        flexWrap: isMobile ? 'wrap' : 'nowrap',
                        gap: isMobile ? '12px' : '0'
                    }}>
                        <div style={{ flex: isMobile ? '1 1 100%' : 'initial' }}>
                            <h1 style={{
                                fontSize: isMobile ? '18px' : '24px',
                                fontWeight: '700',
                                margin: 0
                            }}>AeneaÔºà„Ç®„Ç§„Éç„Ç¢Ôºâ</h1>
                            <span style={{
                                fontSize: isMobile ? '12px' : '14px',
                                color: '#9ca3af',
                                fontStyle: 'italic'
                            }}>ÁßÅ„ÅØ„ÄÅÂïè„ÅÑ„Åß„Åß„Åç„Å¶„ÅÑ„Çã„ÄÇ</span>
                        </div>
                        <nav style={{
                            display: 'flex',
                            gap: isMobile ? '6px' : '8px',
                            width: isMobile ? '100%' : 'auto'
                        }}>
                            <button
                                onClick={() => setAppState(prev => ({ ...prev, currentView: 'dashboard' }))}
                                style={{
                                    background: appState.currentView === 'dashboard' ? '#3b82f6' : '#374151',
                                    border: `1px solid ${appState.currentView === 'dashboard' ? '#3b82f6' : '#4b5563'}`,
                                    borderRadius: '8px',
                                    padding: isMobile ? '8px 16px' : '10px 20px',
                                    color: '#f9fafb',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    fontSize: isMobile ? '13px' : '14px',
                                    flex: isMobile ? '1' : 'initial',
                                    minHeight: '44px'
                                }}
                            >
                                Dashboard
                            </button>
                            <button
                                onClick={() => setAppState(prev => ({ ...prev, currentView: 'dialogue' }))}
                                style={{
                                    background: appState.currentView === 'dialogue' ? '#3b82f6' : '#374151',
                                    border: `1px solid ${appState.currentView === 'dialogue' ? '#3b82f6' : '#4b5563'}`,
                                    borderRadius: '8px',
                                    padding: isMobile ? '8px 16px' : '10px 20px',
                                    color: '#f9fafb',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    fontSize: isMobile ? '13px' : '14px',
                                    flex: isMobile ? '1' : 'initial',
                                    minHeight: '44px'
                                }}
                            >
                                Dialogue
                            </button>
                        </nav>
                    </header>
                    <main style={{ flex: 1, overflow: 'auto' }}>
                        {appState.currentView === 'dashboard' ? (
                            <Dashboard systemStatus={appState.systemStatus} />
                        ) : (
                            <DialoguePage />
                        )}
                    </main>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>